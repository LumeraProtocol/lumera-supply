# Nginx reverse proxy for Lumera Supply API
# Serves the app under https://api.lumera.io/supply/
# Upstream app is expected to listen on 127.0.0.1:8080 (default of the service).

# Example usage on Ubuntu/Debian:
#   sudo cp deploy/nginx.conf /etc/nginx/sites-available/lumera-supply.conf
#   sudo ln -s /etc/nginx/sites-available/lumera-supply.conf /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
# For TLS, either manage certificates manually or use certbot.

server {
    # Listen on HTTP; add a separate server block or listen 443 with certificates for HTTPS
    listen 80;
    listen [::]:80;
    server_name api.lumera.io;

    # Optional: redirect bare path to /supply/
    location = /supply {
        return 301 /supply/;
    }

    # Reverse proxy for the Lumera Supply app under /supply/
    location /supply/ {
        # Strip the /supply prefix when proxying to the app
        # Using trailing slash in proxy_pass replaces the matched prefix with “/”
        proxy_pass http://127.0.0.1:8080/;

        # Forwarded headers so the app can construct public URLs correctly
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        # Critical for this app: tells it the external prefix
        proxy_set_header X-Forwarded-Prefix /supply;

        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Buffering (the responses are small JSON; defaults are fine)
        proxy_buffering on;

        # Security and caching headers (optional; tweak as needed)
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header Referrer-Policy no-referrer-when-downgrade;

        # Let upstream control caching via Cache-Control; you can also enforce here if desired
    }

    # Health check convenience endpoint without prefix (optional)
    location = /healthz {
        return 200 'ok';
        add_header Content-Type text/plain;
    }

    # gzip for JSON/text
    gzip on;
    gzip_types application/json application/yaml text/plain text/css application/javascript;
    gzip_min_length 256;
}
